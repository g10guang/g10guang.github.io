<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Golang 创建文件权限问题 | 刘曦光</title>
<meta name="generator" content="Jekyll v3.7.2" />
<meta property="og:title" content="Golang 创建文件权限问题" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="问题描述" />
<meta property="og:description" content="问题描述" />
<link rel="canonical" href="http://localhost:4000/golang/2018/02/08/golang-make-dir-problem.html" />
<meta property="og:url" content="http://localhost:4000/golang/2018/02/08/golang-make-dir-problem.html" />
<meta property="og:site_name" content="刘曦光" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-02-08T09:00:05+08:00" />
<script type="application/ld+json">
{"description":"问题描述","@type":"BlogPosting","url":"http://localhost:4000/golang/2018/02/08/golang-make-dir-problem.html","headline":"Golang 创建文件权限问题","dateModified":"2018-02-08T09:00:05+08:00","datePublished":"2018-02-08T09:00:05+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/golang/2018/02/08/golang-make-dir-problem.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="刘曦光" />
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">刘曦光</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Golang 创建文件权限问题</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-02-08T09:00:05+08:00" itemprop="datePublished">
        
        Feb 8, 2018
      </time>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="问题描述">问题描述</h1>

<p>今天学习 Golang 文件操作实践时，当我创建一个文件（夹）出现文件权限与我代码设置不一致的问题</p>

<p>以下为我创建文件夹的代码：</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">MkdirAll</span><span class="p">(</span><span class="s">"g10guang/t1/t2"</span><span class="p">,</span><span class="x"> </span><span class="m">0666</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir g10guang/t1: permission denied
</code></pre></div></div>

<blockquote>
  <p>g10guang 文件夹创建成功，可是下面的 t1 文件夹创建失败</p>
</blockquote>

<p>通过 <code class="highlighter-rouge">ls -l</code> 命令查看 g10guang 文件夹信息</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drw-rw-r-- 2 g10guang g10guang 4096 Feb  8 13:23 g10guang
</code></pre></div></div>

<h1 id="linux-权限">Linux 权限</h1>

<p>比如：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drw-rw-r-- 2 g10guang g10guang 4096 Feb  8 13:23 g10guang
</code></pre></div></div>

<p>开头有 10 个字符，我们来一一分析：</p>

<p>第一个 <code class="highlighter-rouge">d</code> 代表这是一个文件夹，<code class="highlighter-rouge">-</code> 为文件，<code class="highlighter-rouge">l</code> 为链接</p>

<p>当前用户与文件关系分为三个等级：</p>
<ul>
  <li>所有者</li>
  <li>同组用户</li>
  <li>其他用户</li>
</ul>

<p>而后面的 9 个字符分别代表文件所有者、同组用户、其他用户对文件的读写权限</p>

<ul>
  <li><code class="highlighter-rouge">r</code> 读权限</li>
  <li><code class="highlighter-rouge">w</code> 写权限</li>
  <li><code class="highlighter-rouge">x</code> 执行权限</li>
  <li><code class="highlighter-rouge">-</code> 不具有该权限</li>
</ul>

<p><code class="highlighter-rouge">rwx</code> ==&gt; 111</p>

<p><code class="highlighter-rouge">rw-</code> ==&gt; 110</p>

<p><code class="highlighter-rouge">r--</code> ==&gt; 100</p>

<p><code class="highlighter-rouge">---</code> ==&gt; 000</p>

<p>如权限 <code class="highlighter-rouge">-rwxrw-r--</code> 表示这是一个文件，文件所有者拥有读写执行权限、同组用户有读写权限、其他用户只有读权限</p>

<p>可以通过 <code class="highlighter-rouge">chmod</code> 改变一个文件的权限，或者 <code class="highlighter-rouge">chown</code> 改变文件的所有者</p>

<p>我们创建文件夹时候指定的权限是 <code class="highlighter-rouge">0666</code>，这是一个八进制数字，拆分成二进制为 <code class="highlighter-rouge">110110110</code>，也就是 <code class="highlighter-rouge">rw-rw-rw-</code>，但是为什么我们创建的文件夹的权限是 <code class="highlighter-rouge">rw-rw-r--</code> 也就是 <code class="highlighter-rouge">0664</code> 呢？</p>

<p>其实我们创建文件夹、文件时候都是经过 Linux 系统调用完成的，所以这是 Linux 创建文件时候会把用户指定的权限 <code class="highlighter-rouge">-</code> 减去 <code class="highlighter-rouge">umask</code>，而我本地 umask 为 <code class="highlighter-rouge">002</code>。通过 <code class="highlighter-rouge">umask</code> 命令查看 umask</p>

<h1 id="分析">分析</h1>

<p>通过 <code class="highlighter-rouge">g10guang</code> 用户运行代码，文件夹当然所属于 <code class="highlighter-rouge">g10guang</code></p>

<p>尝试 <code class="highlighter-rouge">cd g10guang</code>，出现错误，错误信息：<code class="highlighter-rouge">cd: permission denied: g10guang</code></p>

<p>文件夹是属于我的，我怎么不能够 <code class="highlighter-rouge">cd</code> 呢？</p>

<p>原因是：需要 <code class="highlighter-rouge">cd</code> 到一个文件夹，那么必须要有当前文件夹的执行权限 <code class="highlighter-rouge">x</code>，Linux 下设计一切皆文件，文件夹也是一个特殊的文件</p>

<p>如果使用 <code class="highlighter-rouge">os.MkdirAll</code> 方法创建文件夹时，必须基于文件夹所有者 <code class="highlighter-rouge">x</code> 执行权限以及 <code class="highlighter-rouge">w</code> 写权限，为什么需要写权限，可以通过  <code class="highlighter-rouge">vim</code> 去打开一个文件夹，可以看到文件夹里的信息（记得吗，文件夹也是文件），比如我一个文件夹通过 vim 打开的信息：</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">" ============================================================================</span>
<span class="c">" Netrw Directory Listing                                        (netrw v155)</span>
<span class="c">"   /home/g10guang/Templates/blog</span>
<span class="c">"   Sorted by      name</span>
<span class="c">"   Sort sequence: [\/]$,\&lt;core\%(\.\d\+\)\=\&gt;,\.h$,\.c$,\.cpp$,\~\=\*$,*,\.o$,\.obj$,\.info$,\.swp$,\.ba</span>
<span class="c">"   Quick Help: &lt;F1&gt;:help  -:go up dir  D:delete  R:rename  s:sort-by  x:special</span>
<span class="c">" ==============================================================================</span>
<span class="p">..</span>/                                                                                                      
<span class="p">.</span>/
<span class="p">.</span>git/
<span class="p">.</span>sass<span class="p">-</span>cache/
_posts/
_site/
g10guang<span class="p">.</span>github<span class="p">.</span>io/
<span class="p">.</span>gitignore
<span class="p">.</span>gitmodules
<span class="m">404</span><span class="p">.</span>html
Gemfile
Gemfile<span class="p">.</span><span class="k">lock</span>
_config<span class="p">.</span>yml
about<span class="p">.</span>md
index<span class="p">.</span>md
</code></pre></div></div>

<p>文件夹中记录着里面有哪些文件以及文件夹，其中 <code class="highlighter-rouge">xxx/</code> 有 <code class="highlighter-rouge">/</code> 结尾的是文件夹，其他的是文件，所以在文件夹中创建一个文件夹需要改变文件夹信息，需要有写文件夹的权限</p>

<h1 id="创建指定权限文件方法">创建指定权限文件方法</h1>

<p>两种方法：</p>

<ol>
  <li>改变 <code class="highlighter-rouge">umask</code> 后再创建文件，其后再把 <code class="highlighter-rouge">umask</code> 改为原来的 umask</li>
  <li>先创建文件，然后再改变文件的权限</li>
</ol>

<h2 id="方法一">方法一</h2>

<p>改变 <code class="highlighter-rouge">umask</code> 后再创建文件，其后再把 <code class="highlighter-rouge">umask</code> 改为原来的 umask</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
	</span><span class="s">"syscall"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">mask</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Umask</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="x">    </span><span class="c">// 改为 0000 八进制</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Umask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="x">   </span><span class="c">// 改为原来的 umask</span><span class="x">
	</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">MkdirAll</span><span class="p">(</span><span class="s">"g10guang/t1/t2"</span><span class="p">,</span><span class="x"> </span><span class="m">0766</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h2 id="方法二">方法二</h2>

<p>先创建文件，然后再改变文件的权限</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">MkdirAll</span><span class="p">(</span><span class="s">"g10guang/t1/t2"</span><span class="p">,</span><span class="x"> </span><span class="m">0777</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">os</span><span class="o">.</span><span class="n">Chmod</span><span class="p">(</span><span class="s">"g10guang"</span><span class="p">,</span><span class="x"> </span><span class="m">0777</span><span class="p">)</span><span class="x">
    </span><span class="n">os</span><span class="o">.</span><span class="n">Chmod</span><span class="p">(</span><span class="s">"g10guang/t1"</span><span class="p">,</span><span class="x"> </span><span class="m">0777</span><span class="p">)</span><span class="x">
    </span><span class="n">os</span><span class="o">.</span><span class="n">Chmod</span><span class="p">(</span><span class="s">"g10guang/t1/t2"</span><span class="p">,</span><span class="x"> </span><span class="m">0777</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>golang 还不支持递归更改多个文件夹的权限，所有需要一个一个调用。</p>

<h1 id="总结">总结</h1>

<p>Linux 文件操作都是调用 Linux 的系统调用完成的，虽然 <code class="highlighter-rouge">Python</code> 、<code class="highlighter-rouge">java</code> 等创建一个文件不会让显示让编程人员指定所创建的文件的权限，但是 Golang 需要，所以我们编程还是需要了解一点内核知识，比如网络编程涉及到 <code class="highlighter-rouge">I/O</code>，而 Linux 下 I/O 有I/O 阻塞、I/O非阻塞、I/O复用、SIGIO 、异步I/O，而I/O复用中有 select / poll / epoll 等，上次面试被问到 epoll 时，闻所未闻，<a href="https://tech.youzan.com/yi-bu-wang-luo-mo-xing/">更多I/O讲解</a>。</p>

<p>现在找实习、找工作，发现公司会看重面试者是否有阅读源码等经验，因为我们不仅仅需要懂得调用别人的 API 完成某个功能，而且需要某个 API 底层到底完成了哪些操作，出了问题如何定位问题，以及如何解决问题。</p>

  </div>

  

  <a class="u-url" href="/golang/2018/02/08/golang-make-dir-problem.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">刘曦光</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            
              刘曦光
            
            </li>
            
            <li><a class="u-email" href="mailto:g10guang@foxmail.com">g10guang@foxmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/g10guang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">g10guang</span></a></li>
  
  
  
  
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>我会在这里分享我的成长经历、心得，既有IT方面的，也有生活读书方面的。</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
